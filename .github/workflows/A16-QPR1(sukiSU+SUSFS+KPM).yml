name: A16-QPR1-SukiSU-SUSFS-Final

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 深度清理磁盘空间
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'
          
      - name: 准备依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison lld llvm sed \
            libssl-dev libelf-dev libncurses-dev binutils-aarch64-linux-gnu curl git zip dwarves

      - name: 下载 AOSP Clang (r547379)
        run: |
          mkdir -p $GITHUB_WORKSPACE/toolchains
          cd $GITHUB_WORKSPACE/toolchains
          git clone https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 --depth=1 -b android16-release clang-android16-release

      - name: 集成 SukiSU 与 源码外科手术级修复 (完整版)
        run: |
          git config --global user.email "2461654161@qq.com"
          git config --global user.name "XiaolanX"
          
          # 1. 克隆所有源码 (保持十六进制 QPR1 分支一致性)
          git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550.git --depth=1 -b sixteen-qpr1 sm8550
          git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550-modules.git --depth=1 -b sixteen-qpr1 sm8550-modules
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android13-5.15
          cd sm8550
          # 2. 物理搬运 SUSFS 核心文件 (彻底解决 linux/susfs.h not found)
          mkdir -p fs
          mkdir -p include/linux
          cp ../susfs4ksu/kernel_patches/fs/susfs.c ./fs/
          cp ../susfs4ksu/kernel_patches/include/linux/susfs_def.h ./include/linux/
          cp ../susfs4ksu/kernel_patches/include/linux/susfs.h ./include/linux/
          
          # 3. 一加特定的路径桥接 (防止 Kconfig 报错)
          ln -s ../sm8550-modules/kernel/oplus_cpu ./kernel/oplus_cpu
          ln -s ../sm8550-modules/drivers/oplus ./drivers/oplus
          ln -s ../sm8550-modules/include/oplus ./include/oplus
          
          # 4. 集成 SukiSU
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s builtin
          # 5. 【修复】精准重构 ksud.c 语法冲突 (解决20条编译错误)
          python3 <<EOF
          import re, os
          path = 'KernelSU/kernel/ksud.c'
          if not os.path.exists(path):
              print("File not found!"); exit(1)
          
          with open(path, 'r') as f:
              content = f.read()
          
          # 修复 1: 修正 on_post_fs_data 函数 (void 函数返回空)
          # 精准匹配函数定义，替换为完整的空函数体
          content = re.sub(
              r'static void on_post_fs_data\(void\)\s*\{\s*[\s\S]*?^\s*\}',
              'static void on_post_fs_data(void) { return; }',
              content,
              flags=re.MULTILINE
          )
          
          # 修复 2: 彻底重构 ksu_handle_sys_read 函数 (删除所有预处理指令和无效代码)
          # 贪婪匹配完整函数体，替换为无任何残留的空函数
          content = re.sub(
              r'void ksu_handle_sys_read\(unsigned int fd\)\s*\{\s*[\s\S]*?^\s*\}',
              'void ksu_handle_sys_read(unsigned int fd) { return; }',
              content,
              flags=re.MULTILINE
          )
          
          # 修复 3: 修正 bool 函数的返回值 (避免返回空或错误值)
          content = re.sub(
              r'return is_volumedown_enough\(volumedown_pressed_count\);',
              'return false;',
              content
          )
          content = re.sub(
              r'static bool check_argv\(struct subprocess_info \*sub_info\) \{\s*return;\s*\}',
              'static bool check_argv(struct subprocess_info *sub_info) { return false; }',
              content
          )
          
          # 额外防护: 清理残留的孤立 #if/#else/#endif 指令 (针对ksu_handle_sys_read残留)
          content = re.sub(
              r'^\s*#if.*?^\s*#else.*?^\s*#endif.*?$',
              '',
              content,
              flags=re.MULTILINE | re.DOTALL
          )
          
          with open(path, 'w') as f:
              f.write(content)
          EOF

      - name: 物理集成 SUSFS 与 ABI 修复
        working-directory: sm8550
        run: |
          # 核心修复：删除 ABI 保护文件 (预防一加无限重启)
          find . -name "abi_gki_protected_exports_*" -delete || true

      - name: 注入内核配置 (全量功能开启)
        working-directory: sm8550
        run: |
          CONF="arch/arm64/configs/vendor/kalama_GKI.config"
          # 物理删除冲突项
          sed -i '/CONFIG_STACKPROTECTOR/d' $CONF
          sed -i '/CONFIG_DEBUG_INFO_BTF/d' $CONF
          
          # 注入
          {
            echo "CONFIG_KSU=y"
            echo "CONFIG_KSU_SUSFS=y"
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y"
            echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y"
            # 补齐 A.yml 中的高级隐藏项
            echo "CONFIG_KSU_SUSFS_SUS_MAP=y"
            echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y"
            echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y"
            echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y"
            echo "CONFIG_LTO_NONE=y" >> $CONF
            
            echo "CONFIG_KPM=y"
            # 解决 __stack_chk_guard 报错与重启
            echo "CONFIG_STACKPROTECTOR=n"
            echo "CONFIG_STACKPROTECTOR_STRONG=n"
            echo "CONFIG_DEBUG_INFO_BTF=n"
            echo "CONFIG_LTO_CLANG_THIN=y"
          } >> $CONF

      - name: 执行内核编译
        working-directory: sm8550
        run: |
          CLANG_BIN="$GITHUB_WORKSPACE/toolchains/clang-android16-release/clang-r547379/bin"
          export PATH="${CLANG_BIN}:$PATH"
          export LLVM=1
          export LLVM_IAS=1
          
          # 构建配置
          make ARCH=arm64 O=out gki_defconfig vendor/kalama_GKI.config vendor/oplus/kalama_GKI.config
          # 编译：明确指定交叉编译前缀
          make -j$(nproc) ARCH=arm64 O=out \
            CC=clang \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_COMPAT=arm-linux-gnueabi-

      - name: 准备 AnyKernel3 刷机包
        run: |
          git clone https://github.com/Numbersf/AnyKernel3 --depth=1
          # 自动定位 Image
          RAW_IMAGE=$(find sm8550/out/arch/arm64/boot/ -name "Image" -type f | head -n 1)
          cp "$RAW_IMAGE" ./Image
          
          # 执行 KPM 补丁
          curl -LO https://raw.githubusercontent.com/Numbersf/Action-Build/main/patches/patch_linux
          chmod +x patch_linux
          ./patch_linux Image
          mv oImage ./AnyKernel3/Image

      - name: 打包刷机包
        working-directory: AnyKernel3
        run: |
          ZIP_NAME="Aston-SukiSU-Ultra-$(date +%Y%m%d).zip"
          zip -r9 "$ZIP_NAME" * -x .git README.md
          mv "$ZIP_NAME" ../
          echo "ZIP_FINAL_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: 上传刷机包
        uses: actions/upload-artifact@v4
        with:
          name: Aston-Kernel-AnyKernel3
          path: ${{ env.ZIP_FINAL_NAME }}
